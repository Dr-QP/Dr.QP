---
- name: Install Xpra and related packages
  when: install_xpra | default(true)
  block:
    - name: Install curl for Xpra installation script
      ansible.builtin.apt:
        name:
          - curl
        state: present
        update_cache: true
        install_recommends: false

    - name: Install Xpra using official installation script
      ansible.builtin.shell: |
        curl -fsSL https://xpra.org/get-xpra.sh | bash
      changed_when: true

    - name: Install xpra-html5 web client
      ansible.builtin.apt:
        name:
          - xpra-html5
        state: present
        install_recommends: false

    - name: Install VirtualGL from GitHub releases
      block:
        - name: Detect system architecture
          ansible.builtin.set_fact:
            virtualgl_arch: "{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}"

        - name: Get latest VirtualGL release version
          ansible.builtin.shell: |
            curl -s https://api.github.com/repos/VirtualGL/virtualgl/releases/latest | \
            grep '"tag_name"' | sed 's/.*"v\([^"]*\)".*/\1/'
          register: virtualgl_version
          changed_when: false

        - name: Download VirtualGL DEB package
          ansible.builtin.get_url:
            url: "https://github.com/VirtualGL/virtualgl/releases/download/v{{ virtualgl_version.stdout }}/virtualgl_{{ virtualgl_version.stdout }}_{{ virtualgl_arch }}.deb"
            dest: "/tmp/virtualgl_{{ virtualgl_version.stdout }}_{{ virtualgl_arch }}.deb"
            mode: '0644'

        - name: Install VirtualGL DEB package
          ansible.builtin.apt:
            deb: "/tmp/virtualgl_{{ virtualgl_version.stdout }}_{{ virtualgl_arch }}.deb"
            state: present

        - name: Clean up VirtualGL DEB file
          ansible.builtin.file:
            path: "/tmp/virtualgl_{{ virtualgl_version.stdout }}_{{ virtualgl_arch }}.deb"
            state: absent

    - name: Install Mesa and OpenGL support packages
      ansible.builtin.apt:
        name:
          - mesa-utils
          - libgl1
          - libglvnd0
          - xvfb
        state: present
        install_recommends: false

    - name: Install software rendering support (Mesa DRI with llvmpipe)
      ansible.builtin.apt:
        name:
          - libgl1-mesa-dri
        state: present
        install_recommends: false

