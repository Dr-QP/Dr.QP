name: Reformat code

on:
  workflow_dispatch:
  push:
    branches:
      - a_stub_for_act
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

env:
  COMMIT_MESSAGE: Reformatted code

jobs:
  paths-filter:
    name: Need to run?
    runs-on: ${{ vars.AMD_ONLY == '1' && 'ubuntu-24.04' || 'ubuntu-24.04-arm' }}
    permissions: {}
    timeout-minutes: 10
    outputs:
      pass: ${{ steps.override.outputs.pass }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Filters
        uses: ./.github/actions/paths-filter
        id: filter
        with:
          extra-filter: |
            .github/workflows/reformat.yml
            docs/source/notebooks/**
            ansible/**

      - name: Override pass for draft AI PRs
        id: override
        shell: bash
        run: |
          set -e

          pass='${{ steps.filter.outputs.pass }}'
          if [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.pull_request.draft }}" == "true" ]]; then
            case "${{ github.actor }}" in
              *copilot*|*cursor*|*codex*|*claude*)
                pass='false'
                ;;
            esac
          fi

          echo "pass=$pass" >> "$GITHUB_OUTPUT"

  reformat:
    name: Reformat
    needs: paths-filter
    if: needs.paths-filter.outputs.pass == 'true'
    runs-on: ${{ vars.AMD_ONLY == '1' && 'ubuntu-24.04' || 'ubuntu-24.04-arm' }}
    container:
      image: ghcr.io/dr-qp/jazzy-ros-desktop:edge
    permissions: {}
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.REPO_PAT }}

      - name: Add workspace to safe directories
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Setup Python venv
        uses: ./.github/actions/setup-python-venv

      - name: Reformat C++
        shell: bash -le {0}
        run: |
          source /opt/ros/jazzy/setup.bash
          ./scripts/cpp-reformat.sh || true

      - name: Reformat Python
        shell: bash -le {0}
        run: |
          source /opt/ros/jazzy/setup.bash
          ./scripts/python-reformat.sh || true

      - name: Verify if not recursive commit
        id: verify
        shell: bash -le {0}
        run: |
          set -x
          set -e

          if [[ $(git log -1 --pretty=%B) == "$COMMIT_MESSAGE" ]]; then
            echo "Reformatted in previous commit. Skipping commit."
            echo "skip_commit=true" >> "$GITHUB_OUTPUT"
          fi
      # Commit all changed files back to the repository (only for PRs to main)
      - uses: stefanzweifel/git-auto-commit-action@v6
        if: ${{ github.event_name == 'pull_request' && github.base_ref == 'main' && steps.verify.outputs.skip_commit != 'true' }}
        id: commit
        with:
          commit_message: ${{ env.COMMIT_MESSAGE }}

      - name: Verify changes were committed (PRs to main)
        shell: bash -le {0}
        if: ${{ github.event_name == 'pull_request' && github.base_ref == 'main' }}
        run: |
          set -x
          set -e

          git diff --exit-code
          git diff --exit-code --cached

      - name: Verify formatting is correct (PRs to non-main branches)
        shell: bash -le {0}
        if: ${{ github.event_name == 'pull_request' && github.base_ref != 'main' }}
        run: |
          set -x
          set -e

          # Fail if there are any changes needed
          git diff --exit-code || (echo "Error: Code formatting is required. Please run './scripts/cpp-reformat.sh' and './scripts/python-reformat.sh' locally and commit the changes." && exit 1)
          git diff --exit-code --cached


