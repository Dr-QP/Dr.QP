name: Validate Skills

on:
  push:
    branches: [main, develop]
    paths:
      - '.github/skills/**/*.md'
      - '.claude/skills/**/*.md'
      - 'scripts/validate-skills.py'
      - 'scripts/validate_skills/**/*.py'
  pull_request:
    branches: [main, develop]
    paths:
      - '.github/skills/**/*.md'
      - '.claude/skills/**/*.md'
      - 'scripts/validate-skills.py'
      - 'scripts/validate_skills/**/*.py'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate Agent Skills
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run skill validation
        run: |
          python scripts/validate-skills.py --ci --recommend

      - name: Run test suite
        run: |
          pytest scripts/validate_skills/tests --cov=scripts/validate_skills

  finished:
    name: Skill Validation finished
    needs: [validate]
    runs-on: ubuntu-latest
    permissions: {}
    timeout-minutes: 10
    if: ${{ success() || cancelled() || contains(needs.*.result, 'cancelled') || contains(needs.*.result, 'failure') }}
    steps:
      - name: All jobs succeeded!
        if: ${{ success() }}
        run: |
          exit 0
      - name: Some jobs have failed!
        if: ${{ contains(needs.*.result, 'failure') }}
        run: |
          exit 1
      - name: Some jobs have been cancelled!
        if: ${{ cancelled() || contains(needs.*.result, 'cancelled') }}
        run: |
          exit 1
